name: ci

concurrency:
  group: '${{ github.workflow }}-${{ github.head_ref || github.ref }}'
  cancel-in-progress: true

on:
  push:
    branches: [main,develop]
  pull_request:

jobs:
  compile_and_run_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '16'
      - name: Install dependencies
        run: npm ci
      - name: Compile code
        run: npm run compile
      - name: Run test coverage
        run: npm run coverage
      - uses: 5monkeys/cobertura-action@master
        with:
          path: coverage/cobertura-coverage.xml
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          minimum_coverage: 10
          fail_below_threshold: True
          show_line: True
          show_branch: True
          show_missing: True
          link_missing_lines: True
      - name: Run Slither
        uses: crytic/slither-action@v0.1.1
        continue-on-error: true
        id: slither
        with:
          node-version: 16
          sarif: results.sarif
      # - name: Generate Documentation
      #   uses: mattnotmitt/doxygen-action@v1.9.4
      #   with:
      #       working-directory: 'contracts/'
      #       doxyfile-path: 'docs/'
      # - name: Upload SARIF file
      #   uses: github/codeql-action/upload-sarif@v2
      #   with:
      #     sarif_file: ${{ steps.slither.outputs.sarif }}


